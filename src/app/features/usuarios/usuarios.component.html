<div class="usuarios-container">
  <mat-card>
    <mat-card-header>
      <mat-card-title>
        <h1>Gerenciar Usuários</h1>
      </mat-card-title>
      <mat-card-subtitle>
        <span *ngIf="authService.isGestor()">Todos os usuários do sistema</span>
        <span *ngIf="authService.isAtendente()">Clientes para atendimento</span>
      </mat-card-subtitle>
    </mat-card-header>

    <mat-card-content>
    <!-- Filtros -->
    <app-usuarios-filtros
      (filtrosAlterados)="onFiltrosAlterados($event)">
    </app-usuarios-filtros>
      <!-- Ações -->
      <div class="actions-bar">
        <button 
          mat-raised-button 
          color="primary"
          (click)="abrirModalCriarUsuario()"
          *ngIf="podeCriarUsuario()">
          <mat-icon>add</mat-icon>
          Novo Usuário
        </button>

        <button 
          mat-button 
          (click)="buscarPorEmail()"
          *ngIf="authService.isGestor() || authService.isAtendente()">
          <mat-icon>search</mat-icon>
          Buscar por E-mail
        </button>

        <button 
          mat-button 
          (click)="carregarUsuarios()">
          <mat-icon>refresh</mat-icon>
          Atualizar
        </button>

        <!-- Contador de resultados -->
        <div class="resultados-info" *ngIf="!carregando()">
          <span class="resultados-texto">
            {{ usuariosFiltrados().length }} de {{ usuarios().length }} usuário(s)
          </span>
        </div>
      </div>

      <!-- Loading -->
      <div *ngIf="carregando()" class="loading-container">
        <mat-spinner></mat-spinner>
        <p>Carregando usuários...</p>
      </div>

      <!-- Tabela -->
      <!-- Tabela com ordenação -->
      <div class="table-container">
        <table mat-table [dataSource]="paginacao().content" class="mat-elevation-z1">
          
          <!-- Colunas com ordenação -->
          <ng-container *ngFor="let coluna of colunasExibidas" [matColumnDef]="coluna.key">
            
            <!-- Cabeçalho com ordenação -->
            <th mat-header-cell *matHeaderCellDef 
                [class.ordenavel]="coluna.ordenavel"
                (click)="coluna.ordenavel && ordenarTabela(coluna.key)">
              
              <div class="header-content">
                <span>{{ coluna.label }}</span>
                
                <!-- Ícone de ordenação -->
                <mat-icon *ngIf="coluna.ordenavel" class="sort-icon">
                  {{ getOrdenacaoIcon(coluna.key) }}
                </mat-icon>
              </div>
            </th>

            <!-- Células -->
            <td mat-cell *matCellDef="let usuario">
              
              <!-- Nome -->
              <ng-container *ngIf="coluna.key === 'nome'">
                <div class="user-info-cell">
                  <span class="user-name">{{ usuario.nome }}</span>
                  <span *ngIf="!usuario.ativo" class="inativo-badge">Inativo</span>
                </div>
              </ng-container>

              <!-- E-mail -->
              <ng-container *ngIf="coluna.key === 'email'">
                {{ usuario.email }}
              </ng-container>

              <!-- Perfil -->
              <ng-container *ngIf="coluna.key === 'perfilNome'">
                <mat-chip [color]="getPerfilColor(usuario.perfilNome)" selected>
                  {{ usuario.perfilNome }}
                </mat-chip>
              </ng-container>

              <!-- Status -->
              <ng-container *ngIf="coluna.key === 'ativo'">
                <span [class.status-ativo]="usuario.ativo" 
                      [class.status-inativo]="!usuario.ativo">
                  {{ usuario.ativo ? 'Ativo' : 'Inativo' }}
                </span>
              </ng-container>

              <!-- Data -->
              <ng-container *ngIf="coluna.key === 'createdAt'">
                {{ usuario.createdAt | date:'dd/MM/yyyy' }}
              </ng-container>

              <!-- Ações -->
              <ng-container *ngIf="coluna.key === 'acoes'">
                <button mat-icon-button [matMenuTriggerFor]="menu" [disabled]="estaAlterandoStatus(usuario.id)">
                  <mat-icon>more_vert</mat-icon>
                </button>
                <mat-menu #menu="matMenu">
                  <!-- ... menu de ações existente ... -->
                </mat-menu>
              </ng-container>

            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="getColunasKeys()"></tr>
          <tr mat-row *matRowDef="let row; columns: getColunasKeys();"></tr>
        </table>

        <!-- Empty State -->
        <div *ngIf="paginacao().empty && !carregando()" class="empty-state">
          <mat-icon>search_off</mat-icon>
          <h3>Nenhum usuário encontrado</h3>
          <p *ngIf="filtros().busca || filtros().perfilId || filtros().status">
            Tente ajustar os filtros para ver mais resultados.
          </p>
          <p *ngIf="!filtros().busca && !filtros().perfilId && !filtros().status">
            {{ authService.isGestor() ? 'Não há usuários cadastrados no sistema.' : 'Não há clientes cadastrados no sistema.' }}
          </p>
        </div>
      </div>

      <!-- Paginação -->
      <app-pagination
        *ngIf="!carregando() && !paginacao().empty"
        [paginacao]="paginacao()"
        [pageSizeOptions]="[5, 10, 25, 50]"
        [showFirstLastButtons]="true"
        (pageChange)="onMudancaPagina($event)">
      </app-pagination>
    </mat-card-content>
  </mat-card>
</div>